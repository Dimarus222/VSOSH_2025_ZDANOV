<!DOCTYPE html>
<html lang="ru">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="utf-8">
    <title>Ïðîâåðêà áåçîïàñíîñòè QR-êîäà</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #e9ecef;
            color: #343a40;
            font-size: 1em; /* Áàçîâûé ðàçìåð øðèôòà äëÿ âñåé ñòðàíèöû */
        }
        header {
            background-color: #007bff;
            color: white;
            padding: 2em 0; /* Èñïîëüçóåì em äëÿ îòñòóïîâ */
            border-radius: 0 0 0.8em 0.8em;
            position: relative;
        }
        h1 {
            margin: 0;
            font-size: 2em;
        }
        #content {
            max-width: 37.5em; /* 600px / 16px = 37.5em */
            margin: 4em auto;
            background: white;
            border-radius: 0.8em;
            box-shadow: 0 0.25em 1.25em rgba(0, 0, 0, 0.2);
            padding: 2em;
        }
        #qr-input {
            display: none;
        }
        .custom-button-1 {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.6em 1.25em;
            border-radius: 0.3em;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
}
    .custom-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.6em 1.25em;
            border-radius: 0.3em;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
		margin:1em auto;
        }
        .custom-button:hover {
            background-color: #0056b3;
        }
        #upload-button {
            margin: 1.25em 0;
        }
        #qrcode {
            margin: 1.25em auto;
            display: flex;
            justify-content: center;
        }
         #result {
            margin-top: 1.25em;
            font-weight: bold;
            padding: 0.6em;
            border: 1px solid #ddd;
            border-radius: 0.3em;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            max-height: 12.5em;
            overflow: auto;
            text-align: left;
        }
        .create-qr-button {
            position: absolute;
            top: 7em; /* Ïðèìåðíîå çíà÷åíèå, íóæíî ïîäîáðàòü ïîä âûñîòó øàïêè */
            right: 1em; /* Îòñòóï ñïðàâà */
        }

        footer {
            margin: 1.25em 0;
            font-size: 0.9em;
            color: #777;
        }
    </style>
</head>
<body>
    <header>
        <h1>Ïðîâåðêà áåçîïàñíîñòè QR-êîäà</h1>
        
    </header>
<a href="cr.html" class="custom-button-1 create-qr-button">Ñîçäàòü QR-êîä</a> <!-- Êíîïêà ïåðåõîäà -->
    <div id="content">
        <p>Çàãðóçèòå èçîáðàæåíèå ñ QR-êîäîì:</p>
        <label for="qr-input" class="custom-button" id="upload-button">Âûáðàòü ôàéë</label>
        <input type="file" id="qr-input" accept="image/*">
        <div id="qrcode"></div>
        <div id="result"></div>
        <button class="custom-button" onclick="getAllQRCodes()">Ïîêàçàòü âñå QR-êîäû</button>
    </div>
    <footer>
        <p>© 2023 Ïðîâåðêà QR-êîäîâ. Âñå ïðàâà çàùèùåíû.</p>
    </footer>

    <script>
        const phishingLinks = [
            "http://example-phishing.com",
            "http://malicious-site.com",
            "http://scam-website.com",
            // Äîáàâüòå ñâîè ôèøèíãîâûå ññûëêè çäåñü
        ];

        // Îáúÿñíåíèÿ ïî ôèøèíãîâûì ñàéòàì
        const phishingExplanations = {
            "http://example-phishing.com": "Ýòîò ñàéò èìååò ïëîõóþ ðåïóòàöèþ è ÷àñòî èñïîëüçóåòñÿ äëÿ ôèøèíãà.",
            "http://malicious-site.com": "Èçâåñòíî, ÷òî ýòîò ñàéò ñîäåðæèò âðåäîíîñíûå ïðîãðàììû.",
            "http://scam-website.com": "Ýòîò ñàéò áûë ñâÿçàí ñ ìîøåííè÷åñêèìè äåéñòâèÿìè, ÷òî âûçûâàåò íåîáõîäèìîñòü â îñòîðîæíîñòè.",
            // Äîáàâüòå îáúÿñíåíèÿ äëÿ äðóãèõ ññûëîê
        };

        const safeComment = "Ýòîò ñàéò áåçîïàñåí è èìååò õîðîøóþ ðåïóòàöèþ ñðåäè ïîëüçîâàòåëåé.";

        const qrInput = document.getElementById('qr-input');
        const resultDiv = document.getElementById('result');
        const qrcodeDiv = document.getElementById('qrcode');
        let db;

        // Èíèöèàëèçàöèÿ IndexedDB.
        function initDB() {
            const request = indexedDB.open("QRCodeDB", 1);

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                const objectStore = db.createObjectStore("qrcodes", { keyPath: "url" }); // Èñïîëüçóåì URL â êà÷åñòâå êëþ÷à
                objectStore.createIndex("status", "status", { unique: false });
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("Áàçà äàííûõ óñïåøíî èíèöèàëèçèðîâàíà");
            };

            request.onerror = (event) => {
                console.error("Îøèáêà ïðè îòêðûòèè áàçû äàííûõ:", event);
            };
        }

        // Ôóíêöèÿ äëÿ äîáàâëåíèÿ QR-êîäà â áàçó äàííûõ.
        function addQRCode(url, status, comment) {
            const transaction = db.transaction(["qrcodes"], "readwrite");
            const objectStore = transaction.objectStore("qrcodes");

            const request = objectStore.put({ url, status, comment }); // Äîáàâëÿåì ïîëå comment

            request.onsuccess = () => {
                console.log("QR-êîä äîáàâëåí èëè îáíîâëåí â áàçå äàííûõ");
            };

            request.onerror = (event) => {
                console.error("Îøèáêà ïðè äîáàâëåíèè QR-êîäà â áàçó äàííûõ:", event);
            };
        }

        // Ôóíêöèÿ äëÿ ïîëó÷åíèÿ ñòàòóñà URL èç IndexedDB.
        function getQRCodeStatus(url) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["qrcodes"], "readonly");
                const objectStore = transaction.objectStore("qrcodes");
                const request = objectStore.get(url);

                request.onsuccess = (event) => {
                    if (event.target.result) {
                        resolve(event.target.result); // Âîçâðàùàåì âåñü îáúåêò
                    } else {
                        resolve(null); // Åñëè çàïèñü íå íàéäåíà
                    }
                };

                request.onerror = (event) => {
                    reject("Îøèáêà ïðè èçâëå÷åíèè QR-êîäà èç áàçû äàííûõ.");
                };
            });
        }

        // Ôóíêöèÿ äëÿ ïîëó÷åíèÿ âñåõ QR-êîäîâ.
        function getAllQRCodes() {
            const transaction = db.transaction(["qrcodes"], "readonly");
            const objectStore = transaction.objectStore("qrcodes");

            const request = objectStore.getAll();

            request.onsuccess = (event) => {
                const qrcodes = event.target.result;
                if (qrcodes.length > 0) {
                    resultDiv.textContent = "Ñîõðàíåííûå QR-êîäû:\n" + qrcodes.map(q => `${q.url} - ${q.status}\nÊîììåíòàðèé: ${q.comment}`).join('\n');
                } else {
                    resultDiv.textContent = "Íåò ñîõðàíåííûõ QR-êîäîâ.";
                }
            };

            request.onerror = (event) => {
                console.error("Îøèáêà ïðè èçâëå÷åíèè QR-êîäîâ:", event);
            };
        }

        qrInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const image = new Image();
                image.src = e.target.result;

                qrcodeDiv.innerHTML = '';
                const imgElement = document.createElement('img');
                imgElement.src = e.target.result;
                imgElement.style.maxWidth = '100%';
                imgElement.style.borderRadius = '5px';
                qrcodeDiv.appendChild(imgElement);

                image.onload = async () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = image.width;
                        canvas.height = image.height;
                        context.drawImage(image, 0, 0, image.width, image.height);

                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                        const qrCode = jsQR(imageData.data, imageData.width, imageData.height);

                        if (qrCode) {
                            const url = qrCode.data;
                            resultDiv.textContent = `Äàííûå QR-êîäà: ${url}`;

                            // Ïðîâåðêà ñòàòóñà URL â ìàññèâå ôèøèíãîâûõ ññûëîê
                            if (phishingLinks.includes(url)) {
                                const explanation = phishingExplanations[url] || "Äàííûé ñàéò ìîæåò áûòü îïàñíûì. Ðåêîìåíäóåòñÿ èçáåãàòü åãî.";
                                resultDiv.textContent += `\nÑòàòóñ QR-êîäà: Îïàñíûé ñàéò (â ôèøèíãîâîì ñïèñêå)`;
                                resultDiv.textContent += `\nÏðè÷èíà: ${explanation}`;
                                // Äîáàâëÿåì ñòàòóñ â IndexedDB
                                addQRCode(url, 'Îïàñíûé ñàéò', explanation);
                                return;
                            }

                            // Ïðîâåðêà ñòàòóñà URL â áàçå äàííûõ
                            const existingData = await getQRCodeStatus(url);
                            if (existingData !== null) {
                                // Çàïèñü íàéäåíà â áàçå äàííûõ
                                resultDiv.textContent += `\nÑòàòóñ QR-êîäà: ${existingData.status}`;
                                resultDiv.textContent += `\nÊîììåíòàðèé: ${existingData.comment}`;
                            } else if (url.startsWith('http')) {
                                resultDiv.textContent += '\nÏðîâåðÿåì URL íà áåçîïàñíîñòü ÷åðåç Google Safe Browsing API...';
                                const apiKey = 'YOUR_GOOGLE_SAFEBROWSING_API_KEY'; // Çàìåíèòå íà âàø êëþ÷ API
                                const apiUrl = `https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${apiKey}`;
                                const body = {
                                    client: {
                                        clientId: 'YOUR_CLIENT_ID', // Çàìåíèòå íà âàø clientId
                                        clientVersion: '1.5.2'
                                    },
                                    threatInfo: {
                                        threatTypes: ["MALWARE", "SOCIAL_ENGINEERING", "UNWANTED_SOFTWARE", "THREAT_TYPE_UNSPECIFIED"],
                                        platformTypes: ["ANY_PLATFORM", "WINDOWS", "MACOSX", "LINUX"],
                                        threatEntryType: "URL",
                                        threatEntries: [{url}]
                                    }
                                };
                                resultDiv.textContent += '\nÐåçóëüòàò ïðîâåðêè: ';

                                try {
                                    const response = await fetch(apiUrl, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        body: JSON.stringify(body)
                                    });
                                    const data = await response.json();
                                    
                                    let status;
                                    // Ïðîâåðÿåì ñóùåñòâóåò ëè ïîëå threatMatches è èìååò ëè îíî äëèíó
                                    if (data.threatMatches && data.threatMatches.length > 0) {
                                        status = 'Îïàñíûé URL';
                                        resultDiv.textContent += status;
                                        resultDiv.textContent += `\nÏðè÷èíà: Ýòîò ñàéò áûë èäåíòèôèöèðîâàí êàê ñîäåðæàùèé óãðîçó.`;
                                    } else {
                                        status = 'Áåçîïàñíûé URL';
                                        resultDiv.textContent += status;
                                        resultDiv.textContent += `\nÊîììåíòàðèé: ${safeComment}`;
                                    }

                                    // Ñîõðàíÿåì ñòàòóñ â áàçå äàííûõ
                                    addQRCode(url, status, (status === 'Îïàñíûé URL') ? "Ýòîò ñàéò áûë èäåíòèôèöèðîâàí êàê ñîäåðæàùèé óãðîçó." : safeComment);
                                } catch (error) {
                                    resultDiv.textContent += `Îøèáêà ïðè ïðîâåðêå URL: ${error.message}`;
                                }
                            } else {
                                resultDiv.textContent += '\nÝòî íå URL. Ïðîâåðêà íå òðåáóåòñÿ.';
                            }
                        } else {
                            resultDiv.textContent = 'QR-êîä íå ðàñïîçíàí.';
                        }
                    } catch (error) {
                        resultDiv.textContent = 'Îøèáêà ïðè äåêîäèðîâàíèè QR-êîäà: ' + error.message;
                    }
                };
            };
            reader.readAsDataURL(file);
        });

        window.onload = function() {
            initDB();
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</body>
</html>
